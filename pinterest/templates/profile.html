{% extends 'base.html' %}
{% load static %}
{% block content %}
{% if profile %}
{% load humanize %}
<div class="container">

  <!-- Header do Perfil -->
  <div class="text-center mb-4">
    {% if profile.profile_image %}
      <img src="{{ profile.profile_image.url }}" class="rounded-circle" width="120" height="120" alt="{{ profile.user.username }}">
    {% else %}
      <img src="{% static 'images/pessoa.png' %}" class="rounded-circle" width="120" height="120" alt="{{ profile.user.username }}">
    {% endif %}
    <h2 class="mt-2">@{{ profile.user.username }}</h2>
    {% if profile.bio %}
      <p>{{ profile.bio }}</p>
    {% endif %}
    <!-- Botão Follow/Unfollow -->
    <form method="POST" class="d-inline-block">
      {% csrf_token %}
      {% if profile in user.profile.follows.all %}
        <button class="btn btn-outline-danger btn-sm" name="follow" value="unfollow" type="submit">Deixar de Seguir</button>
      {% else %}
        <button class="btn btn-outline-success btn-sm" name="follow" value="follow" type="submit">Follow</button>
      {% endif %}
    </form>
    {% if request.user.id == profile.user.id %}
      <a href="{% url 'update_user' %}" class="btn btn-outline-secondary btn-sm">Atualizar Perfil</a>
    {% endif %}
  </div>

  <div class="row">
    <!-- Pins -->
    <div class="col-md-8">
      {% if pins %}
      <div class="masonry-grid">
        {% for pin in pins %}
        <div class="masonry-item">
          <div class="pin-user mb-2">
            {% if pin.user.profile.profile_image %}
              <img src="{{ pin.user.profile.profile_image.url }}" width="40" height="40" class="rounded-circle" alt="{{ pin.user.username }}">
            {% else %}
              <img src="{% static 'images/pessoa.png' %}" width="40" height="40" class="rounded-circle" alt="{{ pin.user.username }}">
            {% endif %}
            <span class="ms-2">@{{ pin.user.username }}</span>
          </div>
          <img src="{{ pin.image.url }}" class="pin-image" alt="{{ pin.description }}">
          <div class="card-body">
            <p>{{ pin.description }}</p>
            <small class="text-muted d-flex justify-content-between align-items-center">
              {% load humanize %}
              <small class="pin-date text-muted">{{ pin.created_at|naturaltime }}</small>
                {{ pin.number_of_likes }}
                {% if user in pin.likes.all %}
                  <a href="{% url 'pin_like' pin.id %}"><i class="fa-solid fa-heart text-danger"></i></a>
                {% else %}
                  <a href="{% url 'pin_like' pin.id %}"><i class="fa-regular fa-heart text-danger"></i></a>
                {% endif %}
                {% if request.user.username == profile.user.username %}
                  &nbsp;<a href="{% url 'edit_pin' pin.id %}"><i class="fa fa-edit text-secondary"></i></a>
                  &nbsp;<a href="{% url 'delete_pin' pin.id %}"><i class="fa fa-trash text-secondary"></i></a>
                {% endif %}
              </span>
            </small>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
        <p class="text-center">Sem pins no momento.</p>
      {% endif %}
    </div>

    <!-- Coluna do Perfil + Formulário de Pin + Follows/Followers -->
    <div class="col-md-4">


      <!-- Formulário de criação de Pin -->
      {% if request.user.id == profile.user.id and form %}
      <div class="pin-form mb-3">
        <h5 class="mb-2 text-center">Criar novo Pin</h5>
        <form method="POST" enctype="multipart/form-data">
          {% csrf_token %}
          {{ form.as_p }}
          <button type="submit" class="btn btn-primary w-100">Postar Pin!</button>
        </form>
      </div>
      {% endif %}

<!-- Seguindo -->
<div class="pin-form mb-3">
  <h5 class="mb-2 text-center">Seguindo</h5>
  <div class="row row-cols-2 g-2">
    {% for following in profile.follows.all %}
    <div class="col">
      <div class="follow-card text-center">
        <span class="d-block mb-1">@{{ following.user.username }}</span>
        <form method="POST">
          {% csrf_token %}
          <button class="btn btn-outline-danger btn-sm" name="follow" value="unfollow" type="submit">Deixar de Seguir</button>
        </form>
      </div>
    </div>
    {% endfor %}
  </div>
  
</div>

<!-- Seguidores -->
<div class="pin-form mb-3">
  <h5 class="mb-2 text-center">Seguidores</h5>
  <div class="row row-cols-2 g-2">
    {% for follower in profile.followed_by.all|slice:3 %}
    <div class="col">
      <div class="follows-card text-center">
        <span class="d-block mb-1">@{{ follower.user.username }}</span>
        <form method="POST">
          {% csrf_token %}
          {% if follower in profile.follows.all %}
            <button class="btn btn-outline-danger btn-sm" name="follow" value="unfollow" type="submit">Deixar de Seguir</button>
          {% else %}
            <button class="btn btn-outline-success btn-sm" name="follow" value="follow" type="submit">Seguir</button>
          {% endif %}
        </form>
      </div>
    </div>
    {% endfor %}
  </div>
  
</div>

    </div>
  </div>
</div>
{% endif %}
{% endblock %}
